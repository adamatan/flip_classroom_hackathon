{% extends "common/base.html" %}
{% load flip_filters %}
{% load core_filters %}
{% load i18n %}
{% load staticfiles %}
{% block content %}

<div class="container">
    <div class="row">
        <div class="col-xs-12">
            <ol class="breadcrumb">
                <li><a href="{% url 'common:home' %}">{% trans 'Home' %}</a></li>
                {% for ancestor in ancestors %}
                {% if ancestor.entity_type == 'topic' %}
                <li><a href="{% url 'core:topic_view' ancestor.id %}">{{ ancestor }}</a></li>
                {% else %}
                <li><a href="{% url 'core:item_view' ancestor.id %}">{{ ancestor }}</a></li>
                {% endif %}
                {% endfor %}
                <li class="active">{{ video }}</li>
            </ol>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <h1>{{ video.video_title }}</h1>
            <p>
                {% blocktrans with channel=video.youtube_channel user_name=video.user.get_full_name day=video.upload_date.day month=video.upload_date.month|heb_month year=video.upload_date.year %}By {{channel}}, uploaded by {{ user_name }} on {{ day }} {{ month }} {{ year }}{% endblocktrans %}
                {% if perms.core.change_videopage %}
                (<a href="/core/edit-video/{{video.id}}/">{% trans 'edit' %}</a>)
                {% endif %}
            </p>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div class="embed-responsive embed-responsive-16by9">
                <iframe id="youtube-iframe"
                        src="https://www.youtube.com/embed/{{ video.youtube_movie_id }}?hl=he&cc_load_policy=1&enablejsapi=1"
                        frameborder="0" allowfullscreen class="embed-responsive-item"></iframe>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            {{ video.content | safe }}
        </div>
    </div>
    <div class="row top-buffer">
        <div class="col-md-8 text-center">
            <div class="btn-group btn-group-justified " role="group">
                {% if prev %}
                <a id="previous-button" href="{{ prev | teach_entity_url }}" role="button"
                   class="btn btn-primary nav-button">
                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>{% trans 'Previous' %}<br>
                    {{ prev }}
                </a>
                {% endif %}
                <a id="more-button" href="{{ video.teach_item | teach_entity_url }}" role="button"
                   class="btn btn-primary nav-button">
                    <span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span> {% trans 'More' %}<br>
                    {{ video.teach_item }}
                </a>
                {% if next %}
                <a id="next-button" href="{{ next | teach_entity_url }}" role="button"
                   class="btn btn-primary nav-button">
                    {% trans 'Next' %}<span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span><br>
                    {{ next }}
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
  var tag = document.createElement('script');
  tag.id = 'iframe-demo';
  tag.src = 'https://www.youtube.com/iframe_api';
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  var player;
  var prevPlayerPlaying = false;
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('youtube-iframe', {
        events: {
          'onStateChange': onPlayerStateChange
        }
    });
  }

  function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.ENDED) {
        ga('send', 'event', 'video.view', 'ended', player.getVideoData().video_id, {
            'transport': 'beacon'
        });
    } else if (event.data == YT.PlayerState.PLAYING) {
        ga('send', 'event', 'video.view', 'playing', player.getVideoData().video_id, {
            'transport': 'beacon'
        });
        if (!prevPlayerPlaying) {
            ga('send', 'event', 'video.view', 'starting', player.getVideoData().video_id, {
                'transport': 'beacon'
            });
        }
        prevPlayerPlaying = true;
    }
  }

</script>

<script type="text/javascript">
    $("#previous-button").click(function() {
        ga('send', 'event', 'video_page.navigation', 'previous', {
            'transport': 'beacon'
        });
    });
    $("#more-button").click(function() {
        ga('send', 'event', 'video_page.navigation', 'more', {
            'transport': 'beacon'
        });
    });
    $("#next-button").click(function() {
        ga('send', 'event', 'video_page.navigation', 'next', {
            'transport': 'beacon'
        });
    });

</script>
{% endblock %}
